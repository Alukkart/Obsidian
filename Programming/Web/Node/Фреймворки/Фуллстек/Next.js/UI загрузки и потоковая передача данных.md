Специальный файл `loading.js` помогает создавать осмысленный UI загрузки с помощью компонента `Suspense`. Он позволяет мгновенно отображать состояние загрузки во время получения содержимого сегмента роута. Новое содержимое автоматически добавляется после завершения рендеринга.

![[Pasted image 20240820192815.png]]

**Мгновенное состояние загрузки**

Мгновенное состояние загрузки - это резервный UI, который отображается сразу после навигации. Мы можем предварительно рендерить индикаторы загрузки, такие как скелеты и спинеры или небольшие части будущего экрана, такие как обложка, заголовок и др. Это помогает пользователю понять, что приложение работает и обеспечивает лучший UX.

Создайте состояние загрузки путем добавления файла `loading.js` в директорию.

![[Pasted image 20240820192845.png]]

```tsx
export default function Loading() {
  // Мы можем добавлять любой UI внутрь `Loading`, такой как скелет
  return <LoadingSkeleton />
}
```

В той же директории `loading.js` будет вложен в `layout.js`. Он будет оборачивать `page.js` и его потомков в компонент `Suspense`.

![[Pasted image 20240820192910.png]]

**Потоковая передача данных с помощью `Suspense`**

В дополнение к `loading.js` мы можем создавать `Suspense` для своих компонентов UI. Роутер приложения поддерживает потоковую передачу (streaming, далее также - стриминг) как для Node.js, так и для граничной среды выполнения.

_Что такое стриминг?_

Для того, чтобы понять, что такое стриминг в React и Next.js, нужно понимать рендеринг на стороне сервера (server side rendering, SSR) и его ограничения.

В SSR существует несколько шагов, который должны завершиться перед тем, как пользователь сможет увидеть и взаимодействовать со страницей:

1. Все данные, необходимые странице, запрашиваются у сервера.
2. Сервер рендерит HTML для страницы.
3. HTML, CSS и JavaScript для страницы отправляются клиенту.
4. Неинтерактивный UI отображается с помощью сгенерированного HTML и CSS.
5. React [гидратирует](https://react.dev/reference/react-dom/client/hydrateRoot#hydrating-server-rendered-html) UI для того, чтобы сделать его интерактивным.

![[Pasted image 20240820192926.png]]

Эти шаги являются последовательными и блокирующими. Сервер может отрендерить HTML для страницы только после получения всех данных. На клиенте React может гидратировать UI только после загрузки кода всех компонентов.

SSR с помощью React и Next.js помогает улучшить производительной загрузки путем отображения неинтерактивной страницы пользователю как можно быстрее.

![[Pasted image 20240820192936.png]]

Однако это все равно может быть медленным, поскольку получение данных на сервере должно быть завершено перед отображением страницы пользователю.

Стриминг позволяет разбить HTML страницы на небольшие части (chunks) и отправлять их клиенту по-отдельности.

![[Pasted image 20240820192948.png]]

Это позволяет отображать части страницы быстрее, без ожидания получения всех данных для UI.

Стриминг хорошо работает с компонентной моделью React, поскольку каждый компонент может рассматриваться как "чанк" (chunk - часть). Компоненты, которые имеют высший приоритет (например, информация о товаре) или не зависят от данных (например, макет), могут быть отправлены первыми и React может начать их гидратацию раньше. Компоненты с более низким приоритетом (например, отзывы или связанные товары) могут быть отправлены в том же запросе к серверу после получения всех данных.

![[Pasted image 20240820193000.png]]

Стриминг особенно полезен в случаях, когда мы хотим избежать блокировки рендеринга страницы долгими запросами, поскольку это может ухудшить [Time To First Byte (TTFB)](https://web.dev/ttfb/) и [First Contentful Paint (FCP)](https://web.dev/first-contentful-paint/). Это также помогает улучшить [Time to Interactive (TTI)](https://developer.chrome.com/docs/lighthouse/performance/interactive), особенно на медленных устройствах.

_Пример_

`<Suspense>` оборачивает компонент, выполняющий асинхронную операцию (например, запрос данных), отображает резервный UI (например, скелет или спинер) во время выполнения операции и заменяет содержимое компонента после завершения операции.

```tsx
import { Suspense } from 'react'
import { PostFeed, Weather } from './Components'

export default function Posts() {
  return (
    <section>
      <Suspense fallback={<p>Загрузка ленты новостей...</p>}>
        <PostFeed />
      </Suspense>
      <Suspense fallback={<p>Загрузка погоды...</p>}>
        <Weather />
      </Suspense>
    </section>
  )
}
```

Использование `Suspense` дает следующие преимущества:

1. Потоковый серверный рендеринг - прогрессивный рендеринг HTML.
2. Выборочная гидратация - React гидратирует компоненты на основе их приоритетов.

_SEO_

- Next.js ожидает получения данных в функции `generateMetadata` перед началом стриминга UI клиенту. Это гарантирует, что первая часть такого ответа будет содержать теги `<head>`
- поскольку стриминг является серверным, он не влияет на SEO

_Статус-коды_

При стриминге статус-код `200` является индикатором успешного запроса.

Сервер может отправлять клиенту ошибки в потоковом контенте, например, когда используются функции `redirect` или `notFound`, но статус-код обновляться не будет. Это не влияет на SEO.