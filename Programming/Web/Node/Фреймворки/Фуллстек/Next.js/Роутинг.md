## Основы

**Терминология**

![[Pasted image 20240818072834.png]]

- **tree** (дерево) - соглашение о визуализации иерархической структуры. Например, дерево компонентов с родительским и дочерними компонентами, структура директории и др.
- **subtree** (поддерево) - часть дерева, начинающаяся в новом корне (root) и заканчивающаяся в листьях (leaves)
- **root** (корень) - первый узел дерева или поддерева, такой как корневой макет
- **leaf** (лист) - узел поддерева, не имеющий потомков, такой как последней сегмент URL
 ![[Pasted image 20240818072853.png|800]]

- URL segment (сегмент URL) - часть URL, отделенная слэшем
- URL path (путь URL) - часть URL, следующая за доменом (состоит из сегментов)

**Роутер `app`**

В версии 13 Next.js представил новый роутер приложения, разработанный на основе серверных компонентов React, поддерживающий общие (shared) макеты, вложенный роутинг, состояние загрузки, обработку ошибок и др.

Роуты приложения теперь находятся в директории `app`. Раньше такой директорией являлась `pages`. Эти директории могут существовать совместно, например, во время перехода с `pages` на `app` (или до того, как это сделают библиотеки экосистемы Next.js), но `app` имеет приоритет.

По умолчанию компоненты внутри `app` являются серверными. Существуют также клиентские компоненты. Мы поговорим об этом позже.

**Роли директорий и файлов**

В Next.js используется роутинг на основе файловой системы, где:

- директории используются для определения роутов. Роут - это единичный путь вложенных директорий, следующий иерархии файловой системы от корневой директории к финальной листовой директории, содержащей файл `page.js`
- файлы используются для создания UI, отображаемого для сегмента роута

**Сегменты роута**

Каждая директория в роуте представляет его сегмент. Каждый сегмент роута связан с соответствующим сегментом URL.

![[Pasted image 20240818072913.png|800]]

**Вложенные роуты**

Для создания вложенных роутов директории вкладываются друг в друга. Например, мы можем добавить новый роут `/dashboard/settings` путем вложения двух новых директорий в директорию `app`.

Роут `/dashboard/settings` состоит из трех сегментов:

- `/` (корневой сегмент)
- `dashboard` (сегмент)
- `settings` (листовой сегмент)

**Соглашения о файлах**

Next.js предоставляет специальные файлы для создания UI с определенным поведением во вложенных роутах:

|Название|Назначение|
|---|---|
|layout|Общий UI для сегмента и его потомков|
|page|Уникальный UI роута. Делает роут открытым (публично доступным)|
|loading|UI загрузки для сегмента и его потомков|
|not-found|UI отсутствующей страницы для сегмента и его потомков|
|error|UI ошибки для сегмента и его потомков|
|global-error|UI глобальной ошибки|
|route|Серверная конечная точка API|
|template|Специальный повторно используемый UI макета|
|default|Резервный UI для параллельных роутов|

Для специальных файлов могут использоваться расширения `.js,` `.jsx` или `.tsx`.

**Иерархия компонентов**

Компоненты, определенные в специальных файлах сегмента роута, рендерятся в следующем порядке:

-`layout.js` -`template.js` -`error.js` (React error boundary (предохранитель)) -`loading.js` (React suspense boundary (для ленивой загрузка, частичного рендеринга и др.)) -`not-found.js` (предохранитель) -`page.js` или вложенный `layout.js`

  ![[Pasted image 20240818072925.png|800]]

Во вложенном роуте компоненты сегмента будет вложенными внутри компонентов их родительского сегмента.

![[Pasted image 20240818072937.png|800]]

**Совместное размещение**

В дополнение к специальным, мы можем добавлять собственные файлы (компоненты, стили, тесты и др.) в директории `app`.

Это возможно благодаря тому, что публично доступным является только содержимое файлов `page.js` и `route.js`.

![[Pasted image 20240818072954.png|800]]

**Продвинутые паттерны роутинга**

Роутер приложения также позволяет реализовывать более продвинутые паттерны роутинга:

- параллельные роуты - позволяют одновременно показывать несколько страниц в одном отображении (view). На страницы можно переходить независимо. Параллельные роуты используются для разделения отображений, содержащих собственную навигацию. Примером такого компонента может служить панель управления (dashboard)
- перехватывающие роуты - позволяют перехватывать роут и показывать его содержимое в контексте другого роута. Они используются в случаях, когда важно сохранить контекст текущей страницы. Примером такой ситуации может служить просмотр всех задач при редактировании одной из них и увеличение изображения в галерее

Эти паттерны позволяют разрабатывать более богатые и сложные UI.

## Определение роутов

**Создание роута**

В Next.js для определения роутов используются директории.

Каждая директория представляет сегмент роута, связанный с сегментом URL. Для создания вложенного роута директории вкладываются друг в друга.

![[Pasted image 20240818073006.png|800]]

Для того, чтобы сделать сегмент роута доступным публично, используется специальный файл `page.js`.

![[Pasted image 20240818073014.png|800]]

В этом примере URL `/dashboard/analytics` не доступен публично, поскольку в соответствующей директории нет файла `page.js`. Эта директория может использоваться для хранения компонентов, таблиц стилей, изображений и других файлов.

**Создание UI**

Для создания UI для сегмента роута используются специальные файлы. Самыми распространенными являются страницы для отображения уникального UI роута и макеты для отображения UI, который является общим для нескольких роутов.

Например, для создания первой страницы добавьте файл `page.js` в директорию `app` и экспортируйте по умолчанию какой-нибудь компонент:

```tsx
// app/page.tsx
export default function Page() {
  return <h1>Привет, Next.js!</h1>
}
```

## Страницы и макеты

**Страницы**

Страница - это UI, который является уникальным для роута. Страница представляет собой экспортируемый по умолчанию из файла `page.js` компонент.

Например, для создания страницы `index` добавьте файл `page.js` в директорию `app`:

![[Pasted image 20240818073040.png|800]]

```tsx
// `app/page.tsx` - это UI для URL `/`
export default function Page() {
  return <h1>Главная страница</h1>
}
```

**Макеты**

Макет - это UI, который является общим для нескольких роутов. При навигации (переходах между страницами) состояние макета сохраняется, он остается интерактивным и не рендерится повторно. Макеты также могут быть вложенными.

Макет представляет собой компонент, экспортируемый по умолчанию из файла `layout.js`. Этот компонент должен принимать проп `children`, который заполняется (populate) дочерним макетом (при наличии) или страницей в процессе рендеринга.

Например, следующий макет будет общим для страниц `/dashboard` и `/dashboard/settings`:

![[Pasted image 20240818073108.png|800]]

```tsx
// app/page.tsx
export default function DashboardLayout({
  children, // страница или вложенный макет
}: {
  children: React.ReactNode
}) {
  return (
    <section>
      {/* Общий UI, например, шапка или боковая панель */}
      <nav></nav>

      {children}
    </section>
  )
}
```

**Корневой макет (обязательный)**

Корневой макет определяется на верхнем уровне директории `app` и применяется ко всем роутам приложения. Этот макет является обязательным и должен содержать теги `html` и `body`. Он позволяет модифицировать начальный HTML, возвращаемый сервером.

```tsx
// app/layout.tsx
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>
        {/* UI макета */}
        <main>{children}</main>
      </body>
    </html>
  )
}
```

**Вложенные макеты**

По умолчанию макеты в иерархии директорий являются вложенными. Это означает, что они оборачивают дочерние макеты в проп `children`. Макеты могу вкладываться друг в друга путем добавления `layout.js` в определенные сегменты роута (директории).

Например, для создания макета роута `/dashboard` добавьте новый файл `layout.js` в директорию `dashboard`:

![[Pasted image 20240818073118.png|800]]

```tsx
// app/dashboard/layout.tsx
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <section>{children}</section>
}
```

При комбинации этих двух макетов, корневой макет (`app/layout.js`) будет оборачивать макет панели управления (`app/dashboard/layout.js`), который будет оборачивать сегменты роута внутри `app/dashboard/*`.

Два макета буду вложены друг в друга следующим образом:

![[Pasted image 20240818073125.png|800]]

**Шаблоны**

Шаблоны похожи на макеты в том, что они оборачивают каждый дочерний макет или страницу. В отличие от макетов, которые сохраняются между роутами и поддерживают состояние, шаблоны создают новый экземпляр для каждого потомка при навигации. Это означает, что когда пользователь перемещается между роутами, которые делят шаблон, монтируется новый экземпляр компонента, элементы DOM (document object model - объектная модель документа) создаются заново, состояние сбрасывается и эффекты заново синхронизируются.

В некоторых случаях шаблоны предпочтительнее макетов:

- на странице имеется функционал, зависящий от `useEffect` (например, логирование показов страницы) и `useState` (например, постраничная форма обратной связи)
- необходимо изменить дефолтное поведение фреймворка. Например, компонент [Suspense](https://react.dev/reference/react/Suspense) внутри макета показывает резервный контент только при первой загрузке макета, а не при переключении страниц. Для шаблонов резервный контент отображается при каждой навигации

Шаблон определяется путем дефолтного экспорта компонента из файла `template.js`. Этот компонент должен принимать проп `children`.

![[Pasted image 20240818073134.png|800]]

```tsx
// app/template.tsx
export default function Template({ children }: { children: React.ReactNode }) {
  return <div>{children}</div>
}
```

С точки зрения вложенности, шаблон рендерится между макетом и его потомками. Упрощенно это выглядит так:

```tsx
<Layout>
  {/* Обратите внимание, что шаблон имеет уникальный ключ */}
  <Template key={routeParam}>{children}</Template>
</Layout>
```

**Метаданные**

`Metadata API` позволяет модифицировать элементы `head`, такие как `title` и `meta`, в директории `app`.

Метаданные могут определяться путем экспорта объекта `metadata` или функции `generateMetadata` в файлах `layout.js` или `page.js`.

```tsx
// app/page.tsx
import { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Next.js',
}

export default function Page() {
  return '...'
}
```